<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thyroid Ultrasound Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        tr1: '#4CAF50',
                        tr2: '#8BC34A',
                        tr3: '#FFC107',
                        tr4: '#FF9800',
                        tr5: '#F44336',
                    }
                }
            }
        }
    </script>
    <style>
        .thyroid-diagram {
            position: relative;
            width: 300px;
            height: 200px;
            background-color: #e0f7fa;
            border-radius: 50px 50px 0 0;
        }
        .thyroid-diagram::before {
            content: '';
            position: absolute;
            width: 60px;
            height: 20px;
            background-color: #e0f7fa;
            bottom: -20px;
            left: 120px;
        }
        .thyroid-lobe {
            position: absolute;
            width: 100px;
            height: 150px;
            background-color: #b2ebf2;
            border-radius: 50px;
        }
        .left-lobe {
            left: 30px;
            top: 25px;
        }
        .right-lobe {
            right: 30px;
            top: 25px;
        }
        .isthmus {
            position: absolute;
            width: 60px;
            height: 20px;
            background-color: #b2ebf2;
            bottom: 0;
            left: 120px;
        }
        .nodule-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #ff5722;
            border-radius: 50%;
            transform: translate(-6px, -6px);
            cursor: pointer;
        }
        .nodule-marker.selected {
            border: 2px solid #000;
            box-shadow: 0 0 0 2px white;
        }
        .nodule-marker.tr1 { background-color: #4CAF50; }
        .nodule-marker.tr2 { background-color: #8BC34A; }
        .nodule-marker.tr3 { background-color: #FFC107; }
        .nodule-marker.tr4 { background-color: #FF9800; }
        .nodule-marker.tr5 { background-color: #F44336; }
        
        .tirads-indicator {
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, #4CAF50, #8BC34A, #FFC107, #FF9800, #F44336);
            position: relative;
        }
        .tirads-pointer {
            position: absolute;
            top: -5px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #333;
            transform: translateX(-10px);
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: white !important;
                color: black !important;
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600 dark:text-blue-400">Thyroid Ultrasound Report</h1>
            <div class="flex items-center space-x-4">
                <button id="darkModeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
                <button id="saveBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
                <button id="printBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 no-print">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Patient Info and Thyroid Measurements -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Patient Information -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Patient Information</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Patient Name</label>
                            <input type="text" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Date of Birth</label>
                            <input type="date" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">MRN</label>
                            <input type="text" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Exam Date</label>
                            <input type="date" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600" value="">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-1">Prior Exam Comparison</label>
                        <select class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                            <option value="">None available</option>
                            <option value="1month">1 month prior</option>
                            <option value="3month">3 months prior</option>
                            <option value="6month">6 months prior</option>
                            <option value="1year">1 year prior</option>
                            <option value="other">Other (specify in findings)</option>
                        </select>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-1">Clinical Indication</label>
                        <select class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                            <option value="">Select indication...</option>
                            <option value="palpable_nodule">Palpable nodule</option>
                            <option value="incidental_nodule">Incidental nodule on imaging</option>
                            <option value="goiter">Goiter/thyroid enlargement</option>
                            <option value="hyperthyroidism">Hyperthyroidism evaluation</option>
                            <option value="hypothyroidism">Hypothyroidism evaluation</option>
                            <option value="thyroiditis">Thyroiditis evaluation</option>
                            <option value="followup">Follow-up of known nodule</option>
                            <option value="cancer_surveillance">Cancer surveillance</option>
                            <option value="other">Other (specify in findings)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Thyroid Measurements -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Thyroid Measurements</h2>
                    
                    <div class="thyroid-diagram mx-auto mb-6 relative">
                        <div class="left-lobe thyroid-lobe"></div>
                        <div class="right-lobe thyroid-lobe"></div>
                        <div class="isthmus"></div>
                        <!-- Nodule markers will be added here dynamically -->
                    </div>
                    
                    <h3 class="font-medium mb-2">Right Lobe</h3>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div>
                            <label class="block text-xs font-medium mb-1">Length (cm)</label>
                            <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 measurement" data-side="right" data-dim="length">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Width (cm)</label>
                            <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 measurement" data-side="right" data-dim="width">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Height (cm)</label>
                            <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 measurement" data-side="right" data-dim="height">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-medium mb-1">Volume (ml)</label>
                        <input type="text" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 bg-gray-100 dark:bg-gray-700" id="rightVolume" readonly>
                    </div>
                    
                    <h3 class="font-medium mb-2">Left Lobe</h3>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div>
                            <label class="block text-xs font-medium mb-1">Length (cm)</label>
                            <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 measurement" data-side="left" data-dim="length">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Width (cm)</label>
                            <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 measurement" data-side="left" data-dim="width">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Height (cm)</label>
                            <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 measurement" data-side="left" data-dim="height">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-medium mb-1">Volume (ml)</label>
                        <input type="text" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 bg-gray-100 dark:bg-gray-700" id="leftVolume" readonly>
                    </div>
                    
                    <h3 class="font-medium mb-2">Isthmus</h3>
                    <div class="mb-4">
                        <label class="block text-xs font-medium mb-1">Thickness (mm)</label>
                        <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    
                    <h3 class="font-medium mb-2">Parenchyma</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium mb-1">Echogenicity</label>
                            <select class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">
                                <option value="normal">Normal</option>
                                <option value="heterogeneous">Diffusely heterogeneous</option>
                                <option value="hypoechoic">Diffusely hypoechoic</option>
                                <option value="hyperechoic">Diffusely hyperechoic</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Vascularity</label>
                            <select class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600">
                                <option value="normal">Normal</option>
                                <option value="increased">Increased</option>
                                <option value="decreased">Decreased</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Lymph Node Assessment -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">Lymph Node Assessment</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Status</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="lymph_status" value="normal" class="form-radio" checked>
                                <span class="ml-2">Normal</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="lymph_status" value="abnormal" class="form-radio">
                                <span class="ml-2">Abnormal</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="abnormalLymphFields" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Location</label>
                            <select class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600" multiple>
                                <option value="I">Level I</option>
                                <option value="II">Level II</option>
                                <option value="III">Level III</option>
                                <option value="IV">Level IV</option>
                                <option value="V">Level V</option>
                                <option value="VI">Level VI</option>
                                <option value="VII">Level VII</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Characteristics</label>
                            <div class="space-y-2">
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox">
                                        <span class="ml-2">Round shape (L/T > 0.5)</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox">
                                        <span class="ml-2">Loss of fatty hilum</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox">
                                        <span class="ml-2">Peripheral vascularity</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox">
                                        <span class="ml-2">Cystic changes</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox">
                                        <span class="ml-2">Calcifications</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Largest Node Size (mm)</label>
                            <input type="number" step="0.1" min="0" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Middle Column - Nodule Documentation -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Nodule Documentation</h2>
                        <button id="addNoduleBtn" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                            <i class="fas fa-plus mr-1"></i>Add Nodule
                        </button>
                    </div>
                    
                    <div id="noduleList" class="space-y-4">
                        <!-- Nodules will be added here dynamically -->
                        <div class="text-center py-4 text-gray-500" id="noNodulesMessage">
                            No nodules added yet. Click "Add Nodule" to begin.
                        </div>
                    </div>
                </div>
                
                <!-- Additional Findings -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Additional Findings</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Quick Select</label>
                        <div class="flex flex-wrap gap-2">
                            <button class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-sm quick-finding" data-text="No evidence of thyroiditis.">No thyroiditis</button>
                            <button class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-sm quick-finding" data-text="Mild heterogeneous echotexture may suggest chronic thyroiditis.">Chronic thyroiditis</button>
                            <button class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-sm quick-finding" data-text="Post-surgical changes noted.">Post-surgical</button>
                            <button class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-sm quick-finding" data-text="No suspicious cervical lymphadenopathy.">Normal lymph nodes</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Findings</label>
                        <textarea class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="4" placeholder="Describe any additional findings..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Right Column - TI-RADS and Impression -->
            <div class="lg:col-span-1 space-y-6">
                <!-- TI-RADS Calculator -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">ACR TI-RADS Calculator</h2>
                    
                    <div id="tiradsSection" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-1">Selected Nodule</label>
                            <div class="px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 bg-gray-100 dark:bg-gray-700" id="selectedNoduleName">No nodule selected</div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Composition</label>
                                <select class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 tirads-option" data-points="0">
                                    <option value="cystic" data-points="0">Cystic or almost completely cystic (0 points)</option>
                                    <option value="spongiform" data-points="0">Spongiform (0 points)</option>
                                    <option value="mixed" data-points="1">Mixed cystic and solid (1 point)</option>
                                    <option value="solid" data-points="2">Solid or almost completely solid (2 points)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Echogenicity</label>
                                <select class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 tirads-option" data-points="0">
                                    <option value="anechoic" data-points="0">Anechoic (0 points)</option>
                                    <option value="hyperechoic" data-points="1">Hyperechoic or isoechoic (1 point)</option>
                                    <option value="hypoechoic" data-points="2">Hypoechoic (2 points)</option>
                                    <option value="very_hypoechoic" data-points="3">Very hypoechoic (3 points)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Shape</label>
                                <select class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 tirads-option" data-points="0">
                                    <option value="wider" data-points="0">Wider-than-tall (0 points)</option>
                                    <option value="taller" data-points="3">Taller-than-wide (3 points)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Margin</label>
                                <select class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 tirads-option" data-points="0">
                                    <option value="smooth" data-points="0">Smooth (0 points)</option>
                                    <option value="ill_defined" data-points="0">Ill-defined (0 points)</option>
                                    <option value="lobulated" data-points="2">Lobulated or irregular (2 points)</option>
                                    <option value="extrathyroidal" data-points="3">Extra-thyroidal extension (3 points)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Echogenic Foci</label>
                                <div class="space-y-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox tirads-option" data-points="0" data-group="echogenic_foci" value="none">
                                        <span class="ml-2">None (0 points)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox tirads-option" data-points="1" data-group="echogenic_foci" value="macrocalcifications">
                                        <span class="ml-2">Macrocalcifications (1 point)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox tirads-option" data-points="1" data-group="echogenic_foci" value="peripheral_calcifications">
                                        <span class="ml-2">Peripheral calcifications (1 point)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" class="form-checkbox tirads-option" data-points="2" data-group="echogenic_foci" value="punctate_echogenic_foci">
                                        <span class="ml-2">Punctate echogenic foci (2 points)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <div class="flex justify-between mb-1">
                                <span>TI-RADS Points: <span id="tiradsPoints">0</span></span>
                                <span>Level: <span id="tiradsLevel">TR1</span></span>
                            </div>
                            <div class="tirads-indicator mb-2">
                                <div class="tirads-pointer" style="left: 0%;"></div>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-tr1">TR1</span>
                                <span class="text-tr2">TR2</span>
                                <span class="text-tr3">TR3</span>
                                <span class="text-tr4">TR4</span>
                                <span class="text-tr5">TR5</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noNoduleTirads" class="text-center py-4 text-gray-500">
                        Select a nodule to calculate TI-RADS score
                    </div>
                </div>
                
                <!-- Impression and Recommendations -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Impression & Recommendations</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Auto-generated Impression</label>
                        <textarea class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 bg-gray-100 dark:bg-gray-700" rows="3" id="autoImpression" readonly></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">Custom Impression</label>
                        <textarea class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="3" placeholder="Modify the impression as needed..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Recommendations</label>
                        <div class="px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 bg-gray-100 dark:bg-gray-700" id="recommendations">
                            No specific recommendations yet. Add nodules and calculate TI-RADS scores to generate recommendations.
                        </div>
                    </div>
                </div>
                
                <!-- Report Preview -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 no-print">
                    <h2 class="text-xl font-semibold mb-4">Report Preview</h2>
                    <div class="border rounded p-4 h-64 overflow-auto bg-gray-50 dark:bg-gray-700" id="reportPreview">
                        <h3 class="font-bold">THYROID ULTRASOUND REPORT</h3>
                        <div class="my-2 border-t"></div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p><strong>Patient:</strong> <span id="previewName">[Name]</span></p>
                                <p><strong>DOB:</strong> <span id="previewDOB">[Date of Birth]</span></p>
                            </div>
                            <div>
                                <p><strong>MRN:</strong> <span id="previewMRN">[MRN]</span></p>
                                <p><strong>Exam Date:</strong> <span id="previewExamDate">[Exam Date]</span></p>
                            </div>
                        </div>
                        
                        <div class="my-2 border-t"></div>
                        
                        <h4 class="font-semibold mt-2">FINDINGS:</h4>
                        <p id="previewFindings">[Findings will appear here]</p>
                        
                        <h4 class="font-semibold mt-2">IMPRESSION:</h4>
                        <p id="previewImpression">[Impression will appear here]</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('click', function() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        });

        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }

        // Calculate thyroid lobe volume
        function calculateVolume(side) {
            const length = parseFloat(document.querySelector(`.measurement[data-side="${side}"][data-dim="length"]`).value) || 0;
            const width = parseFloat(document.querySelector(`.measurement[data-side="${side}"][data-dim="width"]`).value) || 0;
            const height = parseFloat(document.querySelector(`.measurement[data-side="${side}"][data-dim="height"]`).value) || 0;
            
            // Volume formula: length × width × height × π/6 (ellipsoid formula)
            const volume = (length * width * height * Math.PI / 6).toFixed(1);
            document.getElementById(`${side}Volume`).value = volume + ' ml';
            
            updateReportPreview();
        }

        // Add event listeners for volume calculations
        document.querySelectorAll('.measurement').forEach(input => {
            input.addEventListener('input', function() {
                calculateVolume(this.dataset.side);
            });
        });

        // Lymph node status toggle
        document.querySelectorAll('input[name="lymph_status"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('abnormalLymphFields').classList.toggle('hidden', this.value !== 'abnormal');
                updateReportPreview();
            });
        });

        // Quick findings buttons
        document.querySelectorAll('.quick-finding').forEach(button => {
            button.addEventListener('click', function() {
                const findingsTextarea = document.querySelector('textarea[placeholder="Describe any additional findings..."]');
                findingsTextarea.value += (findingsTextarea.value ? '\n' : '') + this.dataset.text;
                updateReportPreview();
            });
        });

        // Nodule management
        let noduleCount = 0;
        const noduleList = document.getElementById('noduleList');
        const noNodulesMessage = document.getElementById('noNodulesMessage');
        const tiradsSection = document.getElementById('tiradsSection');
        const noNoduleTirads = document.getElementById('noNoduleTirads');
        const selectedNoduleName = document.getElementById('selectedNoduleName');
        
        document.getElementById('addNoduleBtn').addEventListener('click', function() {
            noduleCount++;
            const noduleId = `nodule-${noduleCount}`;
            
            const noduleDiv = document.createElement('div');
            noduleDiv.className = 'border rounded p-4 bg-gray-50 dark:bg-gray-700';
            noduleDiv.id = noduleId;
            noduleDiv.dataset.noduleId = noduleId;
            
            noduleDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">Nodule ${noduleCount}</h3>
                    <button class="text-red-600 delete-nodule" data-nodule="${noduleId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div>
                        <label class="block text-xs font-medium mb-1">Location</label>
                        <select class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 nodule-location">
                            <option value="right_upper">Right lobe - upper</option>
                            <option value="right_mid">Right lobe - mid</option>
                            <option value="right_lower">Right lobe - lower</option>
                            <option value="left_upper">Left lobe - upper</option>
                            <option value="left_mid">Left lobe - mid</option>
                            <option value="left_lower">Left lobe - lower</option>
                            <option value="isthmus">Isthmus</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Position</label>
                        <select class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 nodule-position">
                            <option value="ant_med">Anterior-medial</option>
                            <option value="ant_lat">Anterior-lateral</option>
                            <option value="post_med">Posterior-medial</option>
                            <option value="post_lat">Posterior-lateral</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <div>
                        <label class="block text-xs font-medium mb-1">Length (cm)</label>
                        <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 nodule-dimension" data-dim="length">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Width (cm)</label>
                        <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 nodule-dimension" data-dim="width">
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1">Height (cm)</label>
                        <input type="number" step="0.1" min="0" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 nodule-dimension" data-dim="height">
                    </div>
                </div>
                
                <div class="mb-2">
                    <label class="block text-xs font-medium mb-1">Volume (ml)</label>
                    <input type="text" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 nodule-volume" readonly>
                </div>
                
                <button class="w-full mt-2 px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm calculate-tirads" data-nodule="${noduleId}">
                    Calculate TI-RADS
                </button>
            `;
            
            if (noNodulesMessage) {
                noNodulesMessage.remove();
            }
            
            noduleList.appendChild(noduleDiv);
            
            // Add nodule marker to diagram
            addNoduleMarker(noduleId, noduleCount);
            
            // Set up event listeners for this nodule
            setupNoduleEvents(noduleId);
            
            updateReportPreview();
        });
        
        function addNoduleMarker(noduleId, noduleNumber) {
            const diagram = document.querySelector('.thyroid-diagram');
            const marker = document.createElement('div');
            marker.className = 'nodule-marker';
            marker.id = `marker-${noduleId}`;
            marker.dataset.noduleId = noduleId;
            marker.title = `Nodule ${noduleNumber}`;
            
            // Set initial position (random for demo)
            const left = 30 + Math.random() * 240;
            const top = 25 + Math.random() * 150;
            marker.style.left = `${left}px`;
            marker.style.top = `${top}px`;
            
            diagram.appendChild(marker);
            
            // Make marker draggable
            makeDraggable(marker);
            
            // Add click event to select nodule
            marker.addEventListener('click', function() {
                selectNodule(noduleId);
            });
        }
        
        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                // Get the mouse cursor position at startup
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                // Call a function whenever the cursor moves
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                // Calculate the new cursor position
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                // Set the element's new position
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            
            function closeDragElement() {
                // Stop moving when mouse button is released
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        function setupNoduleEvents(noduleId) {
            const noduleDiv = document.getElementById(noduleId);
            
            // Delete button
            noduleDiv.querySelector('.delete-nodule').addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this nodule?')) {
                    // Remove from DOM
                    noduleDiv.remove();
                    
                    // Remove marker
                    const marker = document.getElementById(`marker-${noduleId}`);
                    if (marker) marker.remove();
                    
                    // If no nodules left, show message
                    if (noduleList.children.length === 0) {
                        noduleList.appendChild(noNodulesMessage);
                    }
                    
                    // If deleted nodule was selected, clear TI-RADS
                    if (tiradsSection.dataset.selectedNodule === noduleId) {
                        tiradsSection.classList.add('hidden');
                        noNoduleTirads.classList.remove('hidden');
                    }
                    
                    updateReportPreview();
                }
            });
            
            // Dimension inputs - calculate volume
            noduleDiv.querySelectorAll('.nodule-dimension').forEach(input => {
                input.addEventListener('input', function() {
                    calculateNoduleVolume(noduleId);
                });
            });
            
            // Location/position changes - update marker color/position
            noduleDiv.querySelector('.nodule-location').addEventListener('change', function() {
                updateNoduleMarker(noduleId);
            });
            
            // TI-RADS calculation button
            noduleDiv.querySelector('.calculate-tirads').addEventListener('click', function() {
                selectNodule(noduleId);
            });
        }
        
        function selectNodule(noduleId) {
            // Update UI to show this nodule is selected
            document.querySelectorAll('.nodule-marker').forEach(marker => {
                marker.classList.remove('selected');
            });
            
            const marker = document.getElementById(`marker-${noduleId}`);
            if (marker) marker.classList.add('selected');
            
            // Update TI-RADS section
            tiradsSection.dataset.selectedNodule = noduleId;
            selectedNoduleName.textContent = `Nodule ${noduleId.split('-')[1]}`;
            tiradsSection.classList.remove('hidden');
            noNoduleTirads.classList.add('hidden');
            
            // Scroll to TI-RADS section
            tiradsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function calculateNoduleVolume(noduleId) {
            const noduleDiv = document.getElementById(noduleId);
            const length = parseFloat(noduleDiv.querySelector('.nodule-dimension[data-dim="length"]').value) || 0;
            const width = parseFloat(noduleDiv.querySelector('.nodule-dimension[data-dim="width"]').value) || 0;
            const height = parseFloat(noduleDiv.querySelector('.nodule-dimension[data-dim="height"]').value) || 0;
            
            // Volume formula: length × width × height × π/6 (ellipsoid formula)
            const volume = (length * width * height * Math.PI / 6).toFixed(2);
            noduleDiv.querySelector('.nodule-volume').value = volume + ' ml';
            
            updateReportPreview();
        }
        
        function updateNoduleMarker(noduleId) {
            const noduleDiv = document.getElementById(noduleId);
            const location = noduleDiv.querySelector('.nodule-location').value;
            const marker = document.getElementById(`marker-${noduleId}`);
            
            if (!marker) return;
            
            // Update marker color based on location
            marker.className = 'nodule-marker'; // Reset classes
            if (location.includes('right')) {
                marker.style.backgroundColor = '#2196F3'; // Blue for right lobe
            } else if (location.includes('left')) {
                marker.style.backgroundColor = '#4CAF50'; // Green for left lobe
            } else {
                marker.style.backgroundColor = '#FF9800'; // Orange for isthmus
            }
            
            // Update marker position based on location (simplified for demo)
            const diagram = document.querySelector('.thyroid-diagram');
            const diagramRect = diagram.getBoundingClientRect();
            
            let left, top;
            
            switch(location) {
                case 'right_upper':
                    left = 200;
                    top = 50;
                    break;
                case 'right_mid':
                    left = 200;
                    top = 100;
                    break;
                case 'right_lower':
                    left = 200;
                    top = 150;
                    break;
                case 'left_upper':
                    left = 100;
                    top = 50;
                    break;
                case 'left_mid':
                    left = 100;
                    top = 100;
                    break;
                case 'left_lower':
                    left = 100;
                    top = 150;
                    break;
                case 'isthmus':
                    left = 150;
                    top = 180;
                    break;
            }
            
            marker.style.left = `${left}px`;
            marker.style.top = `${top}px`;
        }
        
        // TI-RADS calculation
        document.querySelectorAll('.tirads-option').forEach(option => {
            option.addEventListener('change', updateTiradsScore);
        });
        
        function updateTiradsScore() {
            let totalPoints = 0;
            
            // Get points from select elements
            document.querySelectorAll('select.tirads-option').forEach(select => {
                const selectedOption = select.options[select.selectedIndex];
                totalPoints += parseInt(selectedOption.dataset.points) || 0;
            });
            
            // Get points from checkboxes (only one can be selected per group)
            document.querySelectorAll('.tirads-option[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    // For checkboxes in a group, only count the highest point value
                    const group = checkbox.dataset.group;
                    if (group) {
                        const groupCheckboxes = document.querySelectorAll(`.tirads-option[data-group="${group}"]`);
                        let maxPoints = 0;
                        
                        groupCheckboxes.forEach(cb => {
                            if (cb.checked) {
                                const points = parseInt(cb.dataset.points) || 0;
                                if (points > maxPoints) maxPoints = points;
                            }
                        });
                        
                        totalPoints += maxPoints;
                    } else {
                        totalPoints += parseInt(checkbox.dataset.points) || 0;
                    }
                }
            });
            
            // Update points display
            document.getElementById('tiradsPoints').textContent = totalPoints;
            
            // Determine TI-RADS level
            let tiradsLevel = 'TR1';
            let tiradsColor = 'tr1';
            let pointerPosition = '0%';
            
            if (totalPoints >= 7) {
                tiradsLevel = 'TR5';
                tiradsColor = 'tr5';
                pointerPosition = '100%';
            } else if (totalPoints >= 4) {
                tiradsLevel = 'TR4';
                tiradsColor = 'tr4';
                pointerPosition = '75%';
            } else if (totalPoints >= 2) {
                tiradsLevel = 'TR3';
                tiradsColor = 'tr3';
                pointerPosition = '50%';
            } else if (totalPoints >= 1) {
                tiradsLevel = 'TR2';
                tiradsColor = 'tr2';
                pointerPosition = '25%';
            }
            
            document.getElementById('tiradsLevel').textContent = tiradsLevel;
            
            // Update pointer position
            const pointer = document.querySelector('.tirads-pointer');
            pointer.style.left = pointerPosition;
            
            // Update selected nodule marker color
            const selectedNoduleId = tiradsSection.dataset.selectedNodule;
            if (selectedNoduleId) {
                const marker = document.getElementById(`marker-${selectedNoduleId}`);
                if (marker) {
                    marker.className = 'nodule-marker selected ' + tiradsColor;
                }
            }
            
            // Update recommendations
            updateRecommendations(tiradsLevel);
            updateReportPreview();
        }
        
        function updateRecommendations(tiradsLevel) {
            const selectedNoduleId = tiradsSection.dataset.selectedNodule;
            if (!selectedNoduleId) return;
            
            const noduleDiv = document.getElementById(selectedNoduleId);
            const size = parseFloat(noduleDiv.querySelector('.nodule-dimension[data-dim="length"]').value) || 0;
            
            let recommendation = '';
            
            switch(tiradsLevel) {
                case 'TR1':
                    recommendation = 'No FNA recommended. No follow-up needed.';
                    break;
                case 'TR2':
                    recommendation = 'No FNA recommended. No follow-up needed.';
                    break;
                case 'TR3':
                    if (size >= 2.5) {
                        recommendation = 'FNA recommended (≥2.5cm). If not performed, follow-up ultrasound in 1 year.';
                    } else if (size >= 1.5) {
                        recommendation = 'Consider follow-up ultrasound in 1 year (≥1.5cm).';
                    } else {
                        recommendation = 'No FNA recommended. Consider follow-up ultrasound in 2-3 years if clinically indicated.';
                    }
                    break;
                case 'TR4':
                    if (size >= 1.5) {
                        recommendation = 'FNA recommended (≥1.5cm). If not performed, follow-up ultrasound in 1 year.';
                    } else if (size >= 1.0) {
                        recommendation = 'Consider follow-up ultrasound in 1 year (≥1.0cm).';
                    } else {
                        recommendation = 'No FNA recommended. Consider follow-up ultrasound in 1-2 years if clinically indicated.';
                    }
                    break;
                case 'TR5':
                    if (size >= 1.0) {
                        recommendation = 'FNA strongly recommended (≥1.0cm). If not performed, follow-up ultrasound in 6-12 months.';
                    } else if (size >= 0.5) {
                        recommendation = 'Consider follow-up ultrasound in 6-12 months (≥0.5cm).';
                    } else {
                        recommendation = 'No FNA recommended. Consider follow-up ultrasound in 6-12 months if clinically indicated.';
                    }
                    break;
            }
            
            document.getElementById('recommendations').textContent = recommendation;
            
            // Update auto impression
            updateAutoImpression();
        }
        
        function updateAutoImpression() {
            const selectedNoduleId = tiradsSection.dataset.selectedNodule;
            if (!selectedNoduleId) return;
            
            const noduleDiv = document.getElementById(selectedNoduleId);
            const location = noduleDiv.querySelector('.nodule-location').options[noduleDiv.querySelector('.nodule-location').selectedIndex].text;
            const size = parseFloat(noduleDiv.querySelector('.nodule-dimension[data-dim="length"]').value) || 0;
            const volume = noduleDiv.querySelector('.nodule-volume').value;
            const tiradsLevel = document.getElementById('tiradsLevel').textContent;
            
            let impression = `${location} nodule measuring ${size.toFixed(1)} cm (${volume}). `;
            impression += `TI-RADS ${tiradsLevel}. ${document.getElementById('recommendations').textContent}`;
            
            document.getElementById('autoImpression').value = impression;
        }
        
        // Report preview updates
        function updateReportPreview() {
            // Patient info
            const nameInput = document.querySelector('input[type="text"]');
            const dobInput = document.querySelector('input[type="date"]');
            const mrnInput = document.querySelector('input[type="text"]:nth-of-type(2)');
            const examDateInput = document.querySelector('input[type="date"]:nth-of-type(2)');
            
            document.getElementById('previewName').textContent = nameInput.value || '[Name]';
            document.getElementById('previewDOB').textContent = dobInput.value || '[Date of Birth]';
            document.getElementById('previewMRN').textContent = mrnInput.value || '[MRN]';
            document.getElementById('previewExamDate').textContent = examDateInput.value || '[Exam Date]';
            
            // Findings
            let findingsText = '';
            
            // Thyroid measurements
            const rightVolume = document.getElementById('rightVolume').value;
            const leftVolume = document.getElementById('leftVolume').value;
            
            if (rightVolume || leftVolume) {
                findingsText += `Thyroid measurements: Right lobe ${rightVolume || 'not measured'}, Left lobe ${leftVolume || 'not measured'}.\n`;
            }
            
            // Nodules
            const nodules = document.querySelectorAll('[id^="nodule-"]');
            if (nodules.length > 0) {
                findingsText += '\nNODULES:\n';
                nodules.forEach(nodule => {
                    const location = nodule.querySelector('.nodule-location').options[nodule.querySelector('.nodule-location').selectedIndex].text;
                    const position = nodule.querySelector('.nodule-position').options[nodule.querySelector('.nodule-position').selectedIndex].text;
                    const size = nodule.querySelector('.nodule-dimension[data-dim="length"]').value || '0';
                    const volume = nodule.querySelector('.nodule-volume').value || '0 ml';
                    
                    findingsText += `- ${location}, ${position} position: ${size} cm (${volume}).\n`;
                });
            }
            
            // Lymph nodes
            const lymphStatus = document.querySelector('input[name="lymph_status"]:checked').value;
            if (lymphStatus === 'abnormal') {
                findingsText += '\nLYMPH NODES: Abnormal lymph nodes noted.\n';
            } else {
                findingsText += '\nLYMPH NODES: No abnormal lymph nodes identified.\n';
            }
            
            // Additional findings
            const additionalFindings = document.querySelector('textarea[placeholder="Describe any additional findings..."]').value;
            if (additionalFindings) {
                findingsText += `\nADDITIONAL FINDINGS: ${additionalFindings}\n`;
            }
            
            document.getElementById('previewFindings').textContent = findingsText;
            
            // Impression
            const customImpression = document.querySelector('textarea[placeholder="Modify the impression as needed..."]').value;
            document.getElementById('previewImpression').textContent = customImpression || document.getElementById('autoImpression').value || '[Impression will appear here]';
        }
        
        // Save button
        document.getElementById('saveBtn').addEventListener('click', function() {
            // In a real app, this would save to a database
            alert('Report saved successfully!');
            
            // For demo, save to localStorage
            const reportData = {
                patient: {
                    name: document.querySelector('input[type="text"]').value,
                    dob: document.querySelector('input[type="date"]').value,
                    mrn: document.querySelector('input[type="text"]:nth-of-type(2)').value,
                    examDate: document.querySelector('input[type="date"]:nth-of-type(2)').value
                },
                thyroidMeasurements: {
                    rightVolume: document.getElementById('rightVolume').value,
                    leftVolume: document.getElementById('leftVolume').value
                },
                nodules: Array.from(document.querySelectorAll('[id^="nodule-"]')).map(nodule => ({
                    location: nodule.querySelector('.nodule-location').value,
                    position: nodule.querySelector('.nodule-position').value,
                    dimensions: {
                        length: nodule.querySelector('.nodule-dimension[data-dim="length"]').value,
                        width: nodule.querySelector('.nodule-dimension[data-dim="width"]').value,
                        height: nodule.querySelector('.nodule-dimension[data-dim="height"]').value
                    },
                    volume: nodule.querySelector('.nodule-volume').value
                })),
                lymphNodes: document.querySelector('input[name="lymph_status"]:checked').value,
                additionalFindings: document.querySelector('textarea[placeholder="Describe any additional findings..."]').value,
                impression: document.querySelector('textarea[placeholder="Modify the impression as needed..."]').value || document.getElementById('autoImpression').value
            };
            
            localStorage.setItem('thyroidReport', JSON.stringify(reportData));
        });
        
        // Print/PDF button
        document.getElementById('printBtn').addEventListener('click', function() {
            // In a real app, this would generate a PDF
            window.print();
        });
        
        // Auto-save every 30 seconds
        setInterval(() => {
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) saveBtn.click();
        }, 30000);
        
        // Initialize
        updateReportPreview();
    </script>
</body>
</html>